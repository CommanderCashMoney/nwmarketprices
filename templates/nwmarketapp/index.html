<!doctype html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

     <title>New World Market Prices</title>
        {% load static %}
    <link rel="stylesheet" href="{% static 'nwmarketapp/jquery.typeahead.min.css' %}">
    <link rel="stylesheet" href="{% static 'nwmarketapp/bootstrap-4.4.1.css' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'nwmarketapp/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'nwmarketapp/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'nwmarketapp/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'nwmarketapp/site.webmanifest' %}">

</head>
<body>
<!-- Navigation -->
<section>
    <div class="container nopad">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark col-xl-12">
            <a class="navbar-brand" href="#">New World Market Prices</a>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">

                <form class="form-inline my-2 my-lg-0" action="" method="GET" id="search_form">
                    {#          <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">#}
                    {#          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>#}
                    <div class="typeahead__container">
                        <div class="typeahead__field">
                            <div class="typeahead__query">
                                <input class="js-typeahead-country_v1" name="cn" placeholder="Search" autocomplete="off">

                            </div>

                        </div>
                    </div>
                    <span style="padding-left: 10px">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                    </span>
                </form>
            </div>
        </nav>
    </div>
</section>
<section>
    <div class="container">
        <div class="row">
            <div class="col-md-6-1 col-12 text-center bg-dark" id="price_div">
                <h5>Lowest Price as of: -/--/----</h5>

                <div class="col-md-12 col-12 large-text" id="price_block">
                    0.00
                </div>

                <h5>0% price increase since -/--/----</h5>

            </div>
            <div style="height: 1px"><img src="https://img.spacergif.org/v1/spacer.gif" aria-hidden="true" alt=""
                                          width="4px" height="1px"></div>

            <div class="col-md-6-1 col-12 text-center bg-dark">

                <div class="col-md-12 col-12">
                    <div class="text-center">
                        <canvas id="linechart"></canvas>
                    </div>

                </div>

            </div>
        </div>
    </div>
</section>
<hr>
<div class="container">
    <div class="row">

        <div class="col-lg-4 col-6">
            <h3>Popular End Game Items</h3>
            <hr>
            <div class="row popular-text ">
                {% for x in endgame %}
                    <div class="col-7">{{ x.0 }}</div>
                    <div class="col-3 text-right">{{ x.1 }}</div>
                    <div class="col-2 small">{{ x.2|safe }}</div>


                {% endfor %}


            </div>

        </div>
        <div class="col-lg-4 col-6">
            <h3>Popular Base Items</h3>
            <hr>
            <div class="row popular-text ">
                {% for x in base %}
                    <div class="col-7">{{ x.0 }}</div>
                    <div class="col-3 text-right">{{ x.1 }}</div>
                    <div class="col-2 small">{{ x.2|safe }}</div>


                {% endfor %}

            </div>
        </div>


        <div class="col-lg-4 col-12">
            <h3>Competitive Items</h3>
            <hr>
            <div class="col-md-12 col-12" style="height: 250px; padding-bottom: 50px;">
                <canvas id="barchart"></canvas>
                <p class="detail_text">*This shows the items with the highest number of differing prices today. This usually means a lot of undercutting is going on and pricing is competitive.</p>

            </div>
        </div>

    </div>
</div>

<div class="container">
    <div class="row">

        <div class="col-lg-4 col-6">
            <h3>Motes</h3>
            <hr>
            <div class="row popular-text ">
                {% for x in motes %}
                    <div class="col-7">{{ x.0 }}</div>
                    <div class="col-3 text-right">{{ x.1 }}</div>
                    <div class="col-2 small">{{ x.2|safe }}</div>


                {% endfor %}


            </div>

        </div>
        <div class="col-lg-4 col-6">
            <h3>Refining Reagents</h3>
            <hr>
            <div class="row popular-text ">
                {% for x in refining %}
                    <div class="col-7">{{ x.0 }}</div>
                    <div class="col-3 text-right">{{ x.1 }}</div>
                    <div class="col-2 small">{{ x.2|safe }}</div>


                {% endfor %}

            </div>
        </div>


        <div class="col-lg-4 col-12">
            <h3>Trophy Mats</h3>
            <hr>
            <div class="row popular-text ">
                {% for x in trophy %}
                    <div class="col-7">{{ x.0 }}</div>
                    <div class="col-3 text-right">{{ x.1 }}</div>
                    <div class="col-2 small">{{ x.2|safe }}</div>


                {% endfor %}

            </div>
        </div>

    </div>
</div>

<footer class="text-center">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <p>Data from Kshira Sagara server. If you see something that doesn't look right email me at: <span id='em1'></span></p>
            </div>
        </div>
    </div>
</footer>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static 'nwmarketapp/popper.min.js' %}"></script>
    <script src="{% static 'nwmarketapp/bootstrap-4.4.1.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script type="text/javascript" src="{%  static 'nwmarketapp/jquery.typeahead.min.js' %}"></script>

<script>
var part1 = "nwmarketprices";
var part2 = Math.pow(2,6);
var part3 = String.fromCharCode(part2);
var part4 = "gmail.com";
var part5 = part1 + String.fromCharCode(part2) + part4;
document.getElementById("em1").innerHTML = "<a href=" + "mai" + "lto" + ":"
+ part5 + ">" + part1 + part3 + part4 + "</a>"


</script>

<script type="text/javascript">
    $(document).ready(function () {


        // BAR CHART

        const bar_labels = [
            {% for name in top10 %}
                '{{ name.0 }}',
            {% endfor %}

        ]
        const data = {
            labels: bar_labels,
            datasets: [{

                data: [
                    {% for name in top10 %}
                        {{ name.1 }},
                    {% endfor %}

                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgb(39,98,38)',
                    'rgb(180,32,131)',
                    'rgb(136,31,31)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(46,117,45)',
                    'rgb(200,2,139)',
                    'rgb(141,3,3)'
                ],
                borderWidth: 1
            }]
        };

        var ctx = document.getElementById('barchart');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                response: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    bar: {
                        borderWidth: 2,
                    }
                },

                plugins: {
                    legend: {
                        display: false,
                        position: 'bottom',

                    },


                },
                scales: {
                    x: {
                        ticks: {
                            color: "white"
                        }
                    },
                    y: {
                        ticks: {
                            color: "white"
                        }
                    }

                },
                color: "white",
            },
        });
        var cn_list = []
        $.typeahead({
            input: '.js-typeahead-country_v1',
            order: "desc",
            display: "name",
            source: {
                 data: [
                     {% for name in cn_list %}
                         { name: '{{ name.0 }}', id: {{ name.1 }}},
                     {% endfor %}

        ]

            },
            callback: {
                onInit: function (node) {
                    console.log('Typeahead Initiated on ' + node.selector);
                },
                onSubmit: function (node, form, item, event) {
                    event.preventDefault();
                    {#console.log(node)#}
                    {#console.log(form)#}
                    {#console.log(item)#}
                    {#console.log(event)#}
                    {##}
                    {#console.log(item.id)#}
                    var cn_id = item.id
                    var form_data = {cn_id}

                {#console.log(form_data)#}
                    $.ajax({
                        type: 'GET',
                        url: "",
                        data: form_data,
                        success: function (response) {
                            {# Set price block#}
                            $("#price_div").html(`
                                <h5>Lowest Price as of: ${response.last_checked}</h5>
                                <div class="col-md-12 col-12 large-text" id="price_block">
                                     ${response.recent_lowest_price}
                                </div>

                                <h5>${response.price_change}</h5>

                                `)
                            {#   set graph prices #}
                            {#    console.log(response.hist_price)#}

                            //	  LINE CHART
                            const dates = []
                            const prices = []
                            var max_price = []
                            $.each(response.price_graph_data, function () {
                                let dateObj = new Date(this[0])
                                let date = dateObj.getUTCDate()
                                let month = dateObj.getUTCMonth() + 1
                                let dt = month + '-' + date
                                dates.push(dt)
                                prices.push(this[1])

                                max_price.push(this[1])

                            });
                            const avg_prices = []
                            $.each(response.avg_graph_data, function () {
                                avg_prices.push(this[1])
                            });


                            {#console.log(dates)#}
                            {#console.log(prices)#}
                            var max_of_array = Math.max.apply(Math, max_price);



                            {#const labels = ['1/08', '1/9', '1/10', '1/12', '1/13', '1/15', '1/17']#}
                            const line_data = {
                                labels: dates,

                                datasets: [{
                                    label: 'Lowest Price',

                                    data: prices,
                                    fill: false,
                                    borderColor: 'rgb(55, 115, 204)',
                                    backgroundColor: 'white',
                                    tension: 0.1
                                },
                                    {
                                        label: 'Average Price',

                                        data: avg_prices,
                                        borderDash: [10, 5],
                                        fill: false,
                                        borderColor: 'rgb(55, 100, 155)',

                                        tension: 0.1
                                    }
                                ]
                            };
                            var options1 = {
                                scales: {
                                    x: {
                                        ticks: {
                                            color: "white"
                                        }
                                    },
                                    y: {
                                        ticks: {
                                            color: "white"
                                        }
                                    }

                                },
                                color: "white",


                            };
                            if (window.chart != null) {
                                window.chart.destroy();

                            }

                            var ctx = document.getElementById('linechart');
                            window.chart = new Chart(ctx, {
                                type: 'line',
                                data: line_data,
                                options: options1
                            });



                        },

                        error: function (response) {
                            console.log(response)
                        }
                    })
                }

            }
        })
    })


</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WW3EJQVND0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WW3EJQVND0');
</script>
</body>
</html>
