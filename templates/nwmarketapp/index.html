<!doctype html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
     <title>New World Market Prices</title>
        {% load static %}
    <link rel="stylesheet" href="{% static 'nwmarketapp/jquery.typeahead.min.css' %}">
    <link rel="stylesheet" href="{% static 'nwmarketapp/bootstrap-4.4.1.css' %}">
    <link rel="stylesheet" href="{% static 'nwmarketapp/styles.css' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'nwmarketapp/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'nwmarketapp/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'nwmarketapp/favicon-16x16.png' %}">
    <link rel="manifest" href="{% static 'nwmarketapp/site.webmanifest' %}">
    <script>let server_id = {{ server_id }};</script>
    <script type="text/javascript" src="{% static 'nwmarketapp/app.js' %}"></script>
    <script type="text/javascript" src="{% static 'nwmarketapp/createLineGraph.js' %}"></script>
    <script type="text/javascript" src="{% static 'nwmarketapp/configureTypeAhead.js' %}"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WW3EJQVND0"></script>
    <script async src="https://nwdb.info/embed.js"></script>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{% static 'nwmarketapp/popper.min.js' %}"></script>
    <script src="{% static 'nwmarketapp/bootstrap-4.4.1.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script type="text/javascript" src="{%  static 'nwmarketapp/jquery.typeahead.min.js' %}"></script>
</head>
<body>
<!-- Navigation -->
<section>
    <div class="container nopad">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark col-xl-12">
            <a class="navbar-brand" href="#">New World Market Prices</a>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <form class="form-inline my-2 my-lg-0" action="" method="GET" id="search_form">
                    {#          <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">#}
                    {#          <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>#}
                    <div class="typeahead__container search-bar">
                        <div class="typeahead__field">
                            <div class="typeahead__query">
                                <input class="js-typeahead-names" name="cn" placeholder="Search" autocomplete="off" id="cn">
                            </div>
                        </div>
                    </div>
{#                    <span style="padding-left: 10px">#}
{#                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>#}
{#                    </span>#}
                    <span style="padding-left: 10px">
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Select Server
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                {% for server in servers %}
                                    {% if server.1 == server_id %}
                                        <script>
                                        document.getElementById("dropdownMenuButton").innerHTML = '{{ server.0 }}';
                                        </script>
                                    {% else %}
                                        <a class="dropdown-item" href="#" onclick="change_server({{ server.1 }})">{{ server.0 }}</a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </span>
                </form>
            </div>
        </nav>
    </div>
</section>
<section>
    <div class="container">
        <div class="row hidden" id="item-info">
            <div class="col-md-6-1 col-12 text-center bg-dark" id="price_div">
                <h5>Lowest Price as of: -/--/----</h5>
                <div class="col-md-12 col-12 large-text" id="price_block">
                    0.00
                </div>
                <h5>0% price increase since -/--/----</h5>
            </div>
            <div style="height: 1px"><img src="https://img.spacergif.org/v1/spacer.gif" aria-hidden="true" alt=""
                                          width="4px" height="1px"></div>
            <div class="col-md-6-1 col-12 text-center bg-dark">
                <div class="col-md-12 col-12">
                    <div class="text-center">
                        <canvas id="linechart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="welcome-info">
            <div class="col-12 text-center bg-dark">
                <br>
                <div>Welcome to New World Market Prices!</div>
                <br>
                <div>Select an item from the popular item lists, or search for an item from the search bar above.</div>
                <br>
            </div>
        </div>
    </div>
</section>
<hr>
<div class="container">
    <div class="row">
        {% include 'nwmarketapp/snippets/popular.html' with popular=endgame title="Popular End Game Items" %}
        {% include 'nwmarketapp/snippets/popular.html' with popular=base title="Popular Base Items" %}
        <div class="col-lg-4 col-12">
            <h3>Competitive Items</h3>
            <hr>
            <div class="col-md-12 col-12" style="height: 250px; padding-bottom: 50px;">
                <canvas id="barchart"></canvas>
                <p class="detail_text">*This shows the items with the highest number of differing prices today. This usually means a lot of undercutting is going on and pricing is competitive.</p>
            </div>
        </div>
    </div>
</div>
<div class="container">
    <div class="row">
        {% include 'nwmarketapp/snippets/popular.html' with popular=motes title="Motes" %}
        {% include 'nwmarketapp/snippets/popular.html' with popular=refining title="Refining Reagents" %}
        {% include 'nwmarketapp/snippets/popular.html' with popular=trophy title="Trophy Mats" %}
    </div>
</div>
<footer class="text-center">
    <div class="container">
        <div class="row">
            <div class="col-12">
                Data from additional servers coming soon. We are looking for more Market Watchers, head over to the <a href="https://discord.gg/9xfcG6jTVj" style="text-decoration: underline">discord channel</a> to find out more.
            </div>
            <div class="col-12">
                How to <a href="#" data-toggle="modal" data-target="#exportModal" style="text-decoration: underline">export prices</a> for use with gaming.tools crafting calculator
                 <div class="modal fade" id="exportModal" tabindex="-1" role="dialog" aria-labelledby="exportModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content text-left">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Exporting prices to the gaming.tools crafting calculator</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row popular-text" >
                                <ol>
                                    <li><a href="/{% url "latest_prices" %}/?server_id={{ server_id }}" style="text-decoration: underline">Right click here and Save link as..</a></li>
                                    <li>Go to <a href="https://gaming.tools/newworld/price-customization" style="text-decoration: underline" target="_blank">the price customization page</a></li>
                                    <li>Scroll to the bottom and use the Import Prices function</li>
                                    <li>Change the "Minimum Import Availability" to 1 to get all the prices</li>
                                    <img src="{% static 'nwmarketapp/GamingtoolCustomizations.png' %}" width="400px">
                                </ol>
                                The prices exported will be an average of the lowest 5 listings seen in the last scan.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</footer>
<script type="text/javascript">
    function update_prices(response) {
        $("#price_div").html(`
            <h5>Lowest Price as of: ${response.last_checked}</h5>
            <div class="col-md-12 col-12 large-text" id="price_block">
                 ${response.recent_lowest_price}
            </div>
<a href="#" data-toggle="modal" data-target="#exampleModal">Raw data</a> |
<a href="https://nwdb.info/db/item/${response.nwdb_id}" target="_blank">nwdb</a>
            <h5>${response.price_change}</h5>
 <!-- Modal -->
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                 aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Unfiltered 10 lowest prices seen in last update</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row popular-text" id="detail_modal">
                                <div class="col-7">Time seen</div>
								<div class="col-3">Price</div>
                                <div class="col-2">Avail.</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>

                        </div>
                    </div>
                </div>
            </div>
            `)

        $.each(response.detail_view, function (k, v) {
            let dateObj = new Date(v['scan_time'])

            let dt = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString()

            $("#detail_modal").append(`

								<div class="col-7">${dt}</div>
								<div class="col-3">${v['price']}</div>
                                <div class="col-2">${v['quantity']}</div>

             `);

        });

    }


    $(document).ready(function () {
        // BAR CHART
        const bar_labels = [
            {% for name in top10 %}`{{ name.0 | safe }}`, {% endfor %}
        ]
        const data = {
            labels: bar_labels,
            datasets: [{
                data: [
                    {% for name in top10 %}{{ name.1 }},{% endfor %}
                ],
                backgroundColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgb(39,98,38)',
                    'rgb(180,32,131)',
                    'rgb(136,31,31)'
                ],
                borderColor: [
                    'rgb(255, 99, 132)',
                    'rgb(255, 159, 64)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(153, 102, 255)',
                    'rgb(46,117,45)',
                    'rgb(200,2,139)',
                    'rgb(141,3,3)'
                ],
                borderWidth: 1
            }]
        };

        var ctx = document.getElementById('barchart');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: data,
            options: {
                response: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                // Elements options apply to all of the options unless overridden in a dataset
                // In this case, we are setting the border of each horizontal bar to be 2px wide
                elements: {
                    bar: {
                        borderWidth: 2,
                    }
                },

                plugins: {
                    legend: {
                        display: false,
                        position: 'bottom',

                    },


                },
                scales: {
                    x: {
                        ticks: {
                            color: "#F3F3F3"
                        }
                    },
                    y: {
                        ticks: {
                            color: "#F3F3F3"
                        }
                    }

                },
                color: "#F3F3F3",
            },
        });
    })
</script>

</body>
</html>
